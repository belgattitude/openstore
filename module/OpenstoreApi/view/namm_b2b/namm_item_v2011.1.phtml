<?php 
namespace OpenstoreApi\Custom\Namm2007;

use PhpUnitsOfMeasure\PhysicalQuantity\Mass;
use PhpUnitsOfMeasure\PhysicalQuantity\Length;
use \DateTime;
use \DateTimeZone;
use \Zend\Escaper\Escaper;

class Fcts {
    
    static $enablePrintXMLComments = true;

    static function convertKgmInLbs($kg) {
        if ($kg == "")  return 0;
        $mass = new Mass($kg, 'kg');
        $lbs = self::formatNumber($mass->toUnit('lbs'), 2);
        return $lbs;
    }

    static function convertMeterInInch($meter) {
        if ($meter == "")  return 0;
        $length = new Length($meter, 'meter');
        $inches = self::formatNumber($length->toUnit('inch'), 2, '.', '');
        
        return $inches;
    }
    
    static function formatNumber($number, $decimals=2)
    {
        return number_format($number, $decimals, '.', '');
    }        
                

    static function convertDateTime($datetime)
    {
        if ($datetime == '') return '';
        $dt = DateTime::createFromFormat('Y-m-d h:i:s', $datetime);
        $datetime =  $dt->format(DateTime::ATOM);
        //Y-m-d\TH:i:sP
        //2011-08-11T05:39:10.887
        
        return $datetime; 
        
    }
    
    static function convertDate($date) {
        if ($date == '') return '';
        //$tz = new DateTimeZone('Europe\Brussels');
        $d = DateTime::createFromFormat('Y-m-d', $date);
        $date =  $d->format('Y-m-d');
        return $date; 
    }

    static function getPictureMediaUrl($picture_media_id)
    {
        if ($picture_media_id == '') return '';
        $p = 'http://api.emdmusic.com/media/preview/picture/1024x768-90/%pref%/%picture_media_id%.jpg';
        $p = str_replace('%pref%', str_pad(substr($picture_media_id, -2), 2, "0", STR_PAD_LEFT), $p);
        $p = str_replace('%picture_media_id%', $picture_media_id, $p);
        return $p;
    }
    
    static function printXMLComment($comments)
    {
        if (self::$enablePrintXMLComments) {
            echo '<!--';
            echo $comments;
            echo '-->';
        }
    }
}

$esc = new Escaper('utf-8');
http://api.emdmusic.com/media/preview/picture/170x200-90/%%/%picture_media_id%.jpg
$picture_url_spec = "http://api.emdmusic.com/media/picture/%picture_media_id%_1024x768-90.jpg";
?>
<?= '<?xml version="1.0" encoding="utf-8" ?>' . "\n"; ?>
<NAMM_ITEM xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://namm.org/b2b/2009/schemas" version="2011.1">
  <!--
  EMDMusic namm_item_v2011.1.xml template
  Changelog:
     [2014/09/12] Initial implementation
  -->
  
  <Timestamp>2011-08-11T05:39:10.887</Timestamp>
  <Id>38A6C25A-2344-4343-B53D-B8706E1A37DA</Id>
  
  <SupplierId>123121654654654</SupplierId>  
  <Items>
    <?php foreach($this->data as $idx => $line) : ?>
    <?php if ($idx > 0) Fcts::$enablePrintXMLComments = false; ?>  
    <Item>
        <!-- EMD internal id : <?= $line->product_id ?> -->
        <SupplierItemId><?= $esc->escapeHtml(trim($line->product_reference)) ?></SupplierItemId>
        <SupplierModel><?= $esc->escapeHtml(trim($line->product_reference)) ?></SupplierModel>
        <SupplierItemDesc><?= $esc->escapeHtml(trim($line->product_title)) ?></SupplierItemDesc>
        <Kit>N</Kit>
        <Serialized>N</Serialized>
        <BrandName><?= $esc->escapeHtml($line->brand_name) ?></BrandName>
        <CountryOrigin></CountryOrigin>
        <Length><?= Fcts::convertMeterInInch($line->pack_unit_length) ?></Length>
        <Width><?= Fcts::convertMeterInInch($line->pack_unit_width) ?></Width>
        <Height><?= Fcts::convertMeterInInch($line->pack_unit_height) ?></Height>
        <DimUOM>In</DimUOM>
        <Weight><?= Fcts::convertKgmInLbs($line->weight); ?></Weight>
        <WeightUOM>Lbs</WeightUOM>
        <AnnounceDate><?= Fcts::convertDate($line->available_at) ?></AnnounceDate>
        <AvailableDate><?= Fcts::convertDate($line->available_at) ?></AvailableDate>
        <?php Fcts::printXMLComment('UnAvailDate and EndOfProductionDate are not known') ?>
        <WarrantyPartTerm>365</WarrantyPartTerm>
        <WarrantyPartUOM>Day</WarrantyPartUOM>
        <WarrantyLabTerm>0</WarrantyLabTerm>
        <WarrantyLabUOM>Day</WarrantyLabUOM>        
        <Barcodes>
            <Barcode>
                <!-- TODO CHECK -->
                <ID><?= $line->product_barcode_upca ?></ID>
                <Type>GTIN-14</Type>
            </Barcode>
            <Barcode>
                <ID><?= $line->product_barcode_ean13 ?></ID>
                <Type>GTIN-13</Type>
            </Barcode>
        </Barcodes>        
        <Pricing>
            <Price type="MSRP" Currency="<?= $line->currency_reference ?>"><?= Fcts::formatNumber($line->public_price, 2); ?></Price>
            <!-- TODO prices -->
            <Price type="MAP" Currency="USD">4</Price>
            <Price type="Cost" Currency="USD" Qty="1"><?= Fcts::formatNumber($line->price, 2); ?></Price>
        </Pricing>        
        <Containers>
            <Container>
                <Type>Each</Type>
                <Length>52.0000</Length>
                <Width>20.0000</Width>
                <Height>11.0000</Height>
                <DimUOM>IN</DimUOM>
                <Weight>54.5000</Weight>
                <WeightUOM>LBS</WeightUOM>
                <UOM>EA</UOM>
                <QtyPerUOM>1</QtyPerUOM>
                <Barcodes>
                    <Barcode>
                        <ID>4959112057029</ID>
                        <Type>GTIN-13</Type>
                    </Barcode>
                </Barcodes>
            </Container>
            <?php if ($line_pack_qty_carton != '') : ?>
            <Container>
                <Type>Carton</Type>
                <Length><?= Fcts::convertMeterInInch($line->pack_carton_length) ?></Length>
                <Width><?= Fcts::convertMeterInInch($line->pack_carton_width) ?></Width>
                <Height><?= Fcts::convertMeterInInch($line->pack_carton_height) ?></Height>
                <DimUOM>IN</DimUOM>
                <Weight><?= Fcts::convertKgmInLbs($line->pack_carton_weight) ?></Weight>
                <WeightUOM>LBS</WeightUOM>
                <UOM>EA</UOM>
                <QtyPerUOM><?php 
                    $pack_qty_carton = $line->pack_qty_carton;
                    if ($pack_qty_carton != '') {
                        echo number_format($pack_qty_carton, 0);
                    }
                ?></QtyPerUOM>
                <Barcodes>
                    <Barcode>
                        <ID><?= $line->pack_carton_barcode_upc ?></ID>
                        <Type>GTIN-14</Type>
                    </Barcode>
                    <Barcode>
                        <ID><?= $line->pack_carton_barcode_ean ?></ID>
                        <Type>GTIN-14</Type>
                    </Barcode>
                </Barcodes>
            </Container>
            <?php endif; ?>
            <?php if ($line->pack_qty_master_carton != '') : ?>
            <Container>
                <Type>Mastercarton</Type>
                <Length><?= Fcts::convertMeterInInch($line->pack_mastercarton_length) ?></Length>
                <Width><?= Fcts::convertMeterInInch($line->pack_mastercarton_width) ?></Width>
                <Height><?= Fcts::convertMeterInInch($line->pack_mastercarton_height) ?></Height>
                <DimUOM>IN</DimUOM>
                <Weight><?= Fcts::convertKgmInLbs($line->pack_mastercarton_weight) ?></Weight>
                <WeightUOM>LBS</WeightUOM>
                <UOM>EA</UOM>
                <QtyPerUOM><?php 
                    $pack_qty_master_carton = $line->pack_qty_master_carton;
                    if ($pack_qty_master_carton != '') {
                        echo Fcts::formatNumber($pack_qty_master_carton, 0);
                    }
                ?></QtyPerUOM>
                <Barcodes>
                    <Barcode>
                        <ID><?= $line->pack_mastercarton_barcode_upc ?></ID>
                        <Type>GTIN-14</Type>
                    </Barcode>
                    <Barcode>
                        <ID><?= $line->pack_mastercarton_barcode_ean ?></ID>
                        <Type>GTIN-14</Type>
                    </Barcode>
                </Barcodes>
            </Container>
            <?php endif; ?>
            
            
        </Containers>
        <MarketingInfo>
            <!-- todo -->
            <PrimaryCategory>4018156706</PrimaryCategory>
            <ProductURL></ProductURL>
            <ItemDescLong><![CDATA[<?php
                    $desc = trim($line->product_title . ' ' . $line->product_description . ' ' . $line->product_characteristic);
                    echo preg_replace('/(\ ){2,}/', ' ', $desc); ?>]]>
            </ItemDescLong>      
            <Bullets>
              <Bullet/>
            </Bullets>
            <Media>
                <?php if ($line->picture_media_id != '') : ?>
                <Images>
                    <Image Audience="Consumer" View="Primary"><?php if ($line->picture_media_id != '') echo Fcts::getPictureMediaUrl($line->picture_media_id); ?></Image>
                </Images>
                <?php endif; ?>
            </Media>  
            <Keywords>
              <Keyword/>
            </Keywords>            
        </MarketingInfo>        
    </Item>
    <?php endforeach; ?>  
  </Items>
</NAMM_ITEM>